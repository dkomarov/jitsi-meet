commit 0fd0f5b633f2a4f065058b7f168b909fe951078e
Author: isymchych <ivansymchych@gmail.com>
Date:   Fri Dec 25 18:55:45 2015 +0200

    refactoring of Etherpad and Prezi

diff --git a/modules/UI/etherpad/Etherpad.js b/modules/UI/etherpad/Etherpad.js
index f0bf1cb4f..860e44615 100644
--- a/modules/UI/etherpad/Etherpad.js
+++ b/modules/UI/etherpad/Etherpad.js
@@ -1,61 +1,16 @@
-/* global $, config,
-   setLargeVideoVisible, Util */
-
-var VideoLayout = require("../videolayout/VideoLayout");
-var Prezi = require("../prezi/Prezi");
-var UIUtil = require("../util/UIUtil");
-
-var etherpadName = null;
-var etherpadIFrame = null;
-var domain = null;
-var options = "?showControls=true&showChat=false&showLineNumbers=true" +
-    "&useMonospaceFont=false";
-
-
-/**
- * Resizes the etherpad.
- */
-function resize() {
-    if ($('#etherpad>iframe').length) {
-        var remoteVideos = $('#remoteVideos');
-        var availableHeight
-            = window.innerHeight - remoteVideos.outerHeight();
-        var availableWidth = UIUtil.getAvailableVideoWidth();
-
-        $('#etherpad>iframe').width(availableWidth);
-        $('#etherpad>iframe').height(availableHeight);
-    }
-}
+/* global $ */
 
-/**
- * Creates the Etherpad button and adds it to the toolbar.
- */
-function enableEtherpadButton() {
-    if (!$('#toolbar_button_etherpad').is(":visible"))
-        $('#toolbar_button_etherpad').css({display: 'inline-block'});
-}
+import VideoLayout from "../videolayout/VideoLayout";
+import LargeContainer from '../videolayout/LargeContainer';
+import UIUtil from "../util/UIUtil";
+import SidePanelToggler from "../side_pannels/SidePanelToggler";
 
-/**
- * Creates the IFrame for the etherpad.
- */
-function createIFrame() {
-    etherpadIFrame = VideoLayout.createEtherpadIframe(
-            domain + etherpadName + options, function() {
-
-                document.domain = document.domain;
-                bubbleIframeMouseMove(etherpadIFrame);
-                setTimeout(function() {
-                    // the iframes inside of the etherpad are
-                    // not yet loaded when the etherpad iframe is loaded
-                    var outer = etherpadIFrame.
-                        contentDocument.getElementsByName("ace_outer")[0];
-                    bubbleIframeMouseMove(outer);
-                    var inner = outer.
-                        contentDocument.getElementsByName("ace_inner")[0];
-                    bubbleIframeMouseMove(inner);
-                }, 2000);
-            });
-}
+const options = $.param({
+    showControns: true,
+    showChat: false,
+    showLineNumbers: true,
+    useMonospaceFont: false
+});
 
 function bubbleIframeMouseMove(iframe){
     var existingOnMouseMove = iframe.contentWindow.onmousemove;
@@ -71,8 +26,8 @@ function bubbleIframeMouseMove(iframe){
             e.detail,
             e.screenX,
             e.screenY,
-                e.clientX + boundingClientRect.left,
-                e.clientY + boundingClientRect.top,
+            e.clientX + boundingClientRect.left,
+            e.clientY + boundingClientRect.top,
             e.ctrlKey,
             e.altKey,
             e.shiftKey,
@@ -84,48 +39,123 @@ function bubbleIframeMouseMove(iframe){
     };
 }
 
+const DEFAULT_WIDTH = 640;
+const DEFAULT_HEIGHT = 480;
+
+const EtherpadContainerType = "etherpad";
+
+class Etherpad extends LargeContainer {
+    constructor (domain, name) {
+        super();
+
+        const iframe = document.createElement('iframe');
+
+        iframe.src = domain + name + '?' + options;
+        iframe.frameBorder = 0;
+        iframe.scrolling = "no";
+        iframe.width = DEFAULT_WIDTH;
+        iframe.height = DEFAULT_HEIGHT;
+        iframe.setAttribute('style', 'visibility: hidden;');
+
+        this.container.appendChild(iframe);
+
+        iframe.onload = function() {
+            document.domain = document.domain;
+            bubbleIframeMouseMove(iframe);
+
+            setTimeout(function() {
+                const doc = iframe.contentDocument;
+
+                // the iframes inside of the etherpad are
+                // not yet loaded when the etherpad iframe is loaded
+                const outer = doc.getElementsByName("ace_outer")[0];
+                bubbleIframeMouseMove(outer);
+
+                const inner = doc.getElementsByName("ace_inner")[0];
+                bubbleIframeMouseMove(inner);
+            }, 2000);
+        };
+
+        this.iframe = iframe;
+    }
+
+    get isOpen () {
+        return !!this.iframe;
+    }
+
+    get container () {
+        return document.getElementById('etherpad');
+    }
+
+    resize (containerWidth, containerHeight, animate) {
+        let remoteVideos = $('#remoteVideos');
 
-var Etherpad = {
-    /**
-     * Initializes the etherpad.
-     */
-    init: function (name) {
+        let height = containerHeight - remoteVideos.outerHeight();
+        let width = containerWidth;
 
-        if (config.etherpad_base && !etherpadName && name) {
+        $(this.iframe).width(width).height(height);
+    }
 
-            domain = config.etherpad_base;
+    show () {
+        const $iframe = $(this.iframe);
+        const $container = $(this.container);
 
-            etherpadName = name;
+        return new Promise(resolve => {
+            $iframe.fadeIn(300, function () {
+                document.body.style.background = '#eeeeee';
+                $iframe.css({visibility: 'visible'});
+                $container.css({zIndex: 2});
+                resolve();
+            });
+        });
+    }
 
-            enableEtherpadButton();
+    hide () {
+        const $iframe = $(this.iframe);
+        const $container = $(this.container);
 
-            /**
-             * Resizes the etherpad, when the window is resized.
-             */
-            $(window).resize(function () {
-                resize();
+        return new Promise(resolve => {
+            $iframe.fadeOut(300, function () {
+                $iframe.css({visibility: 'hidden'});
+                $container.css({zIndex: 0});
+                resolve();
             });
+        });
+    }
+}
+
+export default class EtherpadManager {
+    constructor (domain, name) {
+        if (!domain || !name) {
+            throw new Error("missing domain or name");
         }
-    },
 
-    /**
-     * Opens/hides the Etherpad.
-     */
-    toggleEtherpad: function (isPresentation) {
-        if (!etherpadIFrame)
-            createIFrame();
+        this.domain = domain;
+        this.name = name;
+        this.etherpad = null;
+    }
 
+    get isOpen () {
+        return !!this.etherpad;
+    }
 
-        if(VideoLayout.getLargeVideoState() === "etherpad")
-        {
-            VideoLayout.setLargeVideoState("video");
-        }
-        else
-        {
-            VideoLayout.setLargeVideoState("etherpad");
-        }
-        resize();
+    openEtherpad () {
+        this.etherpad = new Etherpad(this.domain, this.name);
+        VideoLayout.addLargeVideoContainer(
+            EtherpadContainerType,
+            this.etherpad
+        );
     }
-};
 
-module.exports = Etherpad;
+    toggleEtherpad () {
+        if (!this.isOpen) {
+            this.openEtherpad();
+        }
+
+        let isVisible = VideoLayout.isLargeContainerTypeVisible(
+            EtherpadContainerType
+        );
+
+        VideoLayout.showLargeVideoContainer(EtherpadContainerType, !isVisible);
+    }
+}
